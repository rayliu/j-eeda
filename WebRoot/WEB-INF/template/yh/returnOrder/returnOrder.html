<%layout("/yh/layout.html"){%>
<style>
	.bar {
	    height: 18px;
	    background: green;
	    border:1px solid #000;
	}
</style>
<link href="/yh/js/plugins/sco/css/sco.message.css" rel="stylesheet">
<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> -->
<link rel="stylesheet" href="/yh/js/plugins/jQuery-File-Upload-9.9.3/css/jquery.fileupload.css">
        <div id="page-wrapper">
            <div class="row">
           
                <div class="col-lg-12">
                    <div class="btn-header" style="font-size: 32px">回单</div>                  
                    <input type="hidden" id="returnId" value="${returnOrder.id!''}">
                    <input type="hidden" id="returnStatus" value="${returnOrder.transaction_status!''}">
                    <input type="hidden" id="transferOrderId" value="${transferOrder.id!''}">
                    <input type="hidden" id="deliveryOrderId" value="${returnOrder.delivery_order_id!''}">
                    
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        
                        <!-- /.panel-heading -->
                        <div class="panel-body" id="total">
                       
                         <%if(saveOK!''==true){%>  
		    <div class="alert alert-success">
              <button type="button" class="close" data-dismiss="alert">×</button>
             	 保存成功
            </div>
		    <%}%>
                            <!-- Nav tabs -->
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="#basic" data-toggle="tab" id = "chargeCheckOrderbasic">基本信息</a></li>
                               
                                <li class=""><a href="#arap" data-toggle="tab" id = "returnOrderPayment">应收</a></li>
                           		<li class=""><a href="#sign" data-toggle="tab" id = "signPicture">签收图片</a></li> 
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div class="tab-pane fade active in" id="basic">
                                <div class="row">
                                <img alt="" src="">
                               <div class="col-lg-6">
                                <input class="form-control" id="snature" type="hidden" >
                                    <form role="form" method="post" action="" id="returnOrderForm">
                                     <input type="hidden" name="refused" id="refused" value="${isRefused}">
                                     <input type="hidden" name="id" id="returnOrderid" value="${returnOrder.id}">
                                     <input id='sign_document_no' name='sign_document_no' type="hidden"  value="${deliveryOrder.ref_no!''}">
                                   		  <h2>回单信息</h2>  
                                   		  <div class="form-group">
                                             <label>回单号:</label>
                                             <label class="radio-inline"></label><strong>${returnOrder.order_no!''}</strong>
                                             <span id='checkQrCode' style="margin-left:20px;">手机签收二维码</span>
                                             <div id="qrcodeCanvas" class="popover fade right in" style="display:none; padding:20px;left:330px;"></div>
                                             
                                          </div>
                                          <div class="form-group" id="status">
                                             <label>状态:</label>
                                             <label class="radio-inline"></label>
                                             <span id="sp_status"></span>
                                          </div>  
                                          <div class="form-group">
                                              <label>回单创建人:</label>
                                              <label class="radio-inline"></label><%if(userLogin.c_name!''==''){ %>${userLogin.user_name!''}<%}else{%>${userLogin.c_name!''}<%}%>
                                          </div>                                                                               
                                          <div class="form-group">
                                              <label>回单创建时间:</label>
                                              <label class="radio-inline"></label>${returnOrder.create_date!''}
                                          </div>
                                        
                                        <h2>客户信息</h2>  
                                         <div class="form-group">
                                            <label>公司名称:</label>	${customerContact.company_name!''}
                                        </div>
                                        <div class="form-group">
                                            <label>地址:</label>	${customerContact.address!''}
                                        </div>                                                                               
                                        <div class="form-group">
                                            <label>联系人:</label>	${customerContact.contact_person!''}
                                        </div>                                        
                                        <div class="form-group">
                                            <label>电话:</label>	${customerContact.phone!''}
                                        </div>
                                        <div id="customer_deliver_no">  
	                                        <div class="form-group">
	                                            <label>客户配送单号</label> 
	                                            <input name="customer_delivery_no" value="${deliveryOrder.customer_delivery_no!''}" class="form-control">	
	                                        </div>
	                                         <div class="form-group">
								             <label >签收单据号</label> 
	        								 <input class="form-control"  name="SignNo" id ="sign_no" value="${deliveryOrder.ref_no!''}">
							                </div>
	                                    </div>
                                        <input id="locationChanged" name='locationChanged' type="hidden" value="false"/>
                                        <div id="contactInformation">
    	                                        <h2>收货人信息</h2>
    	                                        <div class="form-group">
    	                                            <label>收货人公司名称</label>
    	                                            <input name="company_name" value="${contact.company_name!''}${receiving_unit!''}" class="form-control" placeholder="请输入公司名称">
    	                                        </div>
    	                                        <div class="form-group">
    	                                            <label>收货地址</label>
    	                                            <input name="address" value="${contact.address!''}${receiving_address!''}" class="form-control" placeholder="请输入收货地址">
    	                                        </div>
    	                                        <div class="form-group">
    	                                            <label>联系人</label>
    	                                            <input name="contact_person" value="${contact.contact_person!''}${receiving_name!''}" class="form-control" placeholder="请输入联系人">
    	                                        </div>
    	                                        <div class="form-group">
    	                                            <label>电话</label>
    	                                            <input name="phone" value="${contact.phone!''}${receiving_phone!''}" class="form-control" placeholder="请输入电话">
    	                                        </div>
                                            </div>
                                    </div>
                                    
                                <!-- /.col-lg-6 (nested) -->
                                <div class="col-lg-6">
	                                <div class="form-group">
	                                   <h2>运输信息</h2> 
	                                    </div> 
	                      				<div class="form-group">
	                                        <label>运输单号: </label>	<strong>${transferOrder.order_no!''}</strong>
	                                    </div> 
	                                    <div class="form-group">
	                                        <label>配送单号: </label>	<strong>${deliveryOrder.order_no!''}</strong>
	                                    </div>
	                                    <div class="form-group">
	                                        <label>客户单号: </label>	<strong>${transferOrder.customer_order_no!''}</strong>
	                                    </div>                                       
	                                    <div class="form-group">
	                                     <label >业务员: </label>  ${userLoginTo.c_name!''}                                    
	                                    </div>
	                                    <div class="form-group">
	                                        <label>货品属性: </label>	<span id="cargoNatureSpan"><input id="cargoNature" type="hidden" value="${transferOrder.cargo_nature!''}"></span>
	                                    </div>
	                                    <div class="form-group">
	                                        <label>提货方式: </label>	<span id="pickupModeSpan"><input id="pickupMode" type="hidden" value="${transferOrder.pickup_mode!''}"></span>                                        
	                                    </div>                                        
                                        <div class="form-group">
                                            <label>到达方式: </label>	<span id="arrivalModeSpan"><input id="arrivalMode" type="hidden" value="${transferOrder.arrival_mode!''}"></span>                                            
                                        </div>                                         
	                                    <h2>路线</h2>
	                                   			 <div class="form-group">
	                                           		<label>始发地</label>	${locationFrom.province!''} ${locationFrom.city!''} ${locationFrom.district!''}                              
	                                       			 </div>       
	                                              <!-- <div class="form-group">                                        
	                                              	<label>终点</label>		${locationTo.province!''} ${locationTo.city!''} ${locatioTo.district!''}      
	                                 			</div>  --> 
	                                 			<div class="form-group" >
	                                            <input id="locationTo" type="hidden" name="route_to" value="${departOrder.route_to!''}">
	                                           	<label>目的地</label>
			                                     <div class="form-control" style="padding: 0px 0px;box-shadow:none;border:none;height:35px;">       
			                                        <label>省</label>
			                                        <input id="hideProvinceTo" type="hidden" value="${locationTo.province!''}"/>
			                                        <select id="mbProvinceTo" class="valid" name="mbProvinceTo" value=""></select>
			                                        <label>市</label>
			                                        <input id="hideCityTo" type="hidden" value="${locationTo.city!''}"/>
			                                        <select  id="cmbCityTo"  class="valid" name="cmbCityTo" value=""></select>
			                                        <label>区(县)</label>
			                                        <input id="hideDistrictTo" type="hidden" value="${locationTo.district!''}" />
			                                        <select  id="cmbAreaTo" class="valid" name="cmbAreaTo" value=""></select>
			                                    	</div>
			                                    </div>
	                                 			<div class="form-group">
	                                            <label>备注</label>
	                                            <textarea class="form-control" rows="6" name="remark">${returnOrder.remark!''}</textarea>
	                                        </div> 
	                                      
	                                </div>
	                                
                                </form>
                                <!-- /.col-lg-6 (nested) -->
                            </div>
                           				<br>
                                        <h3><label>货品明细</label></h3>     
                                        <div class="table-responsive">
			                                <br/>   
			                                <table class="table table-striped table-bordered table-hover" id="transferOrderTable">
			                                    <thead>
			                                        <tr>
			                                        	<th>序列号</th>
			                                            <th>型号</th>
	                                                    <th>名称</th>
	                                                    <th>长(mm)</th>
	                                                    <th>宽(mm)</th>
	                                                    <th>高(mm)</th>
	                                                    <th>重量(kg)</th>
	                                                    <th>数量</th>
	                                                    <th>件数</th>
	                                                    <th>单位</th>
	                                                    <th>总重量(kg)</th>
	                                                    <th>总体积(m³)</th>                                  
	                                                    <th>备注</th>
			                                        </tr>
			                                    </thead>
			                                    <tbody>                                        
			                                    </tbody>
			                                </table>
			                            </div>
                                                                
                           
                         </div>
                                
                            
                                <div class="tab-pane fade" id="arap">
                                    <!-- <h2>应收</h2> -->
                                    
                                    <input type="hidden" id="receivableTotal" value="${receivableTotal!''}">
                                    <div class="panel-body">
                                    	<button class="btn  btn-primary" id="addrow2">添加应收</button>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered table-hover" id ="table_fin">
                                                <thead>
                                                    <tr>
                                                        <th>客户</th>
                                                        <th>运输单号</th>
                                                        <th>配送单号</th>
                                                        <th>费用条目</th>
                                                        <th>金额</th>
                                                        <th>备注</th>
                                                        <th>结算状态</th>
                                                        <th>费用来源</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                   
                                                </tbody>
                                                <div id="receivableItemList" style="display:none;">
	                                            	<%for(receivableItem in receivableItemList){ %>
   														<option value='${receivableItem.ID!''}'>${receivableItem.NAME!''}</option>
	   												<%		
	   													}
	   												%>
                                            	</div>
                                            </table>
                                        </div>
                                        <!-- /.table-responsive -->
                                    </div>
                                    <!-- /.panel-body -->
                                    
                                </div>     
                                
                                <div class="tab-pane fade" id="sign">
                                    <div class="panel-body">             
                                        <div class="row">
                                        	<input type="hidden" id="files" name="files" value="${files!''}">
									  		<div class="col-lg-12" style="clear:both;">
									  			<div class="form-group"> 
										  			<!-- <input id="savefile" type="button" class="btn  btn-primary" value="上传图片" aria-describedby="helpBlock">
										  			<span id="helpBlock" class="help-block">(图片格式为：gif,jpeg,png,jpg)</span>
		                                        	<form method="POST" id="fileForm" enctype="multipart/form-data">
		                                        		<img src="" id="return_img" name="return_img" alt="" style="display: none;">
		                                            	<input type="hidden" id="return_id" name="return_id" value="${returnOrder.id!''}">
		                                                <input type="file" id="fileupload" name="fileupload" accept="image/*" style="position:absolute; filter:alpha(opacity=0); opacity:0; width:30px;">
		                                                <div id="canvasDiv">  
      													</div> 
		                                            </form >
	                                            	<input id="fileToUpload" type="file" name="fileToUpload" accept="image/*" multiple> 
	                                            	<button class="ui-btn ui-icon-add ui-corner-all" id="imgUploadBtn">压缩上传</button> -->

						                            <span class="btn btn-success fileinput-button">
						                                <i class="glyphicon glyphicon-plus"></i>
						                                <span>选择图片</span>
						                                <!-- The file input field used as target for the file upload widget -->
						                                <input id="fileupload" type="file" name="files[]" multiple="">
						                            </span>                                                
												    <br>
	                                            </div>
	                                    	</div>
		                                    <div class="col-lg-12" style="clear:both;" id="showPictures">
      											<!-- <div data-role="popup" id="info_pop" class="ui-content" data-theme="d" style='font-weight:bold;font-size:14px; z-index: 999; background-color: white;'>  
											        <p>未知错误</p>  
											    </div> -->  
											    <!-- 显示图片必须保证此权限点已存在 -->
		                                    <% if(shiro.hasPermission("ReturnOrder.imgoperation")){%>
		                                    		<input type="hidden" id="permission" value="permissionYes">
				                               		<%for(orderAttachmentFile in OrderAttachmentFileList){ %>
		                                    		<div style="margin-right: 10px;float:left;" >
			                                    		<!-- <img src="/upload/fileupload/${orderAttachmentFile.FILE_PATH!''}" alt="" class="imgSign" style="width:135px;height:180px;"> -->
			                                    		<img src="/upload/img/${orderAttachmentFile.FILE_PATH!''}" alt="" class="img-thumbnail" style="height:180px;">
			                                    		<p>
			                                    			<a class="picture_audit" picture_id="${orderAttachmentFile.ID!''}" ><%if(orderAttachmentFile.AUDIT == 1 || orderAttachmentFile.AUDIT == true ){%> 已审核 <%}else{%> 待审核 <%}%></a>
			                                    			<a class="picture_del" picture_id="${orderAttachmentFile.ID!''}" > 删除 </a>
                                                ${orderAttachmentFile.photo_type!''}
			                                    		</p>
		                                    		</div>
   													              <%}%> 
				                               	<%}else{%>
				                               		<input type="hidden" id="permission" value="permissionNo">
				                               		<%for(orderAttachmentFile in OrderAttachmentFileList){ %>
				                               			<%if(orderAttachmentFile.AUDIT == 1 || orderAttachmentFile.AUDIT == true){%>
			                                    		<div style="margin-right: 10px;float:left;" >
				                                    		<!-- <img src="/upload/fileupload/${orderAttachmentFile.FILE_PATH!''}" alt="" class="imgSign" style="width:180px;height:180px;"> -->
				                                    		<img src="/upload/img/${orderAttachmentFile.FILE_PATH!''}" alt="" class="img-thumbnail" style="height:180px;">
                                                <p>
                                                  ${orderAttachmentFile.photo_type!''}
                                                </p>
			                                    		</div>
			                                    		<%}%>
   													              <%}%>
				                               	<%}%>

		                                    </div>
										</div>
                                    </div>
                            	</div>

                            	<div class="panel-heading">
	                                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false" data-backdrop="static">
	                                  <div class="modal-dialog">
	                                    <div class="modal-content">
	                                        <div class="modal-body" align="center">
	                                        	<center id="centerBody">
	                                            	<!-- <img src="/yh/image/loading5.gif" width="20%"> -->
	                                            	<h4 id="imgProgress"></h4>
	                                            	<div id="progress">
														<div class="bar" style="width: 0%;"></div>
													</div>
	                                            </center>
	                                        </div>
	                                        <div class="modal-footer" id="footer" aria-hidden="true">
									        	<button type="button" class="btn  btn-primary" data-dismiss="modal" id="cancel">关闭</button>
									      	</div>
	                                    </div>
	                                  </div>
	                                </div>
	                            </div>
                            	
                            	<div class="panel-heading">
                            		<div class="modal fade bs-example-modal-lg" id="myModal_img" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
	                                  <div class="modal-dialog modal-dialog modal-lg"  id="imgContent">
	                                    <div class="modal-content">
	                                    	<div class="modal-header">
											     <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
											     <h4 class="modal-title" id="myModalLabel">照片预览&nbsp;</h4>
										    </div>
	                                        <div class="modal-body" align="center" id="lgImgDiv">
	                                        	<img src="" />
	                                        </div>
	                                    </div>
	                                  </div>
	                                </div>
	                            </div>
                            	
                                <div class="form-group"><hr/>
                        			<a style="display:none" id ="style"><i class='fa fa-check'></i></a>
                        			<% if(shiro.hasPermission("ReturnOrder.update")){%>
                                	<button id="saveReturnOrderBtn" type="button" class="btn  btn-primary" data-toggle="tooltip" title="" data-original-title="Default tooltip">保存</button> 
                                	<%}%>
                                	<% if(shiro.hasPermission("ReturnOrder.completed")){%>
                                	<button id="returnOrderAccomplish" type="button" class="btn  btn-primary" data-toggle="tooltip" title="" data-original-title="Default tooltip">回单签收</button>
                                	<button id="returnOrderRefused" type="button" class="btn  btn-primary" data-toggle="tooltip" title="" data-original-title="Default tooltip">拒绝签收</button> 
                                	<%}%>
                                	<a class="btn  btn-primary" href="/returnOrder">返回</a> 
                                </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->

            </div>
        </div>
        <!-- /#page-wrapper -->

<%}%>
<%
	var title=SYS_CONFIG.system_title!'';
%>
<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td>
            <span class="preview"></span>
        </td>
        <td>
            <p class="name">{%=file.name%}</p>
            <strong class="error text-danger"></strong>
        </td>
        <td>
            <p class="size">Processing...</p>
            <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
        </td>
        <td>
            {% if (!i && !o.options.autoUpload) { %}
                <button class="btn btn-primary start" disabled>
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>上传</span>
                </button>
            {% } %}
            {% if (!i) { %}
                <button class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>取消</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        <td>
            <span class="preview">
                {% if (file.thumbnailUrl) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                {% } %}
            </span>
        </td>
        <td>
            <p class="name">
                {% if (file.url) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                {% } else { %}
                    <span>{%=file.name%}</span>
                {% } %}
            </p>
            {% if (file.error) { %}
                <div><span class="label label-danger">Error</span> {%=file.error%}</div>
            {% } %}
        </td>
        <td>
            <span class="size">{%=o.formatFileSize(file.size)%}</span>
        </td>
        <td>
            {% if (file.deleteUrl) { %}
                <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Delete</span>
                </button>
                <input type="checkbox" name="delete" value="1" class="toggle">
            {% } else { %}
                <button class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>
<script>
	var returnOrder = {};
	returnOrder.ex_cargo = "${customizeField.EX_CARGO!'贵重物品'}";
	returnOrder.ex_type = "${customizeField.EX_TYPE!'公司自提'}";
	returnOrder.orderNo = "${returnOrder.order_no!''}";
</script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/vendor/jquery.ui.widget.js"></script>
<script src="/yh/js/plugins/JavaScript-Load-Image-1.13.0/tmpl.min.js"></script>
<script src="/yh/js/plugins/JavaScript-Load-Image-1.13.0/js/load-image.all.min.js"></script>
<script src="/yh/js/plugins/JavaScript-Canvas-to-Blob-2.0.5/js/canvas-to-blob.min.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.iframe-transport.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-process.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-image.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-audio.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-video.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-validate.js"></script>
<script src="/yh/js/plugins/jQuery-File-Upload-9.9.3/js/jquery.fileupload-ui.js"></script>
<script src="/yh/js/plugins/jquery-qrcode/jquery.qrcode.min.js"></script>
<script src="/yh/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="/yh/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="/yh/js/jquery.validate.min.js"></script>
<script src="/yh/js/jvalidate.messages_cn.js"></script>

<script src="/yh/js/returnOrder/edit.js"></script>
<script src="/yh/js/returnOrder/edit_file_upload.js"></script>
<script src="/yh/js/plugins/sco/js/sco.message.js"></script>