<%layout("/yh/layout.html"){%>


<div id="page-wrapper">
<div class="row">
	<h2>产品信息</h2>
	<div class="col-lg-4">
		<h4>客户信息</h4>
		<input type="hidden" id="customerId" />
		<input type="hidden" id="categoryId" />
	    <div class="form-group">
	        <!--label>客户名称</label-->
	        <input id="customerMessage" class="form-control" placeholder="选择客户" type="text" name="customerMessage" />
	        <ul id='customerList' class="pull-right dropdown-menu default" tabindex="-1" style="top: 17%; left: 2%;">
			</ul>
	    </div>
	    <div id="treeListDiv" style="display: none;">
	    	<div class="tree " style="clear: both;">
			    <ul>
			        <li id="productTreeLi">
			            <span id="parentTree"><i class="fa fa-folder-open"></i></span>
			            <a class='fa fa-plus addCategory' href='javascript:void(0)' title='添加类别' data-target="#editCategory"></a>
			            <ul id="productTreeUl"></ul>			            
			        </li>
			    </ul>
			</div>
        </div>
		<div>
	        <ul id="treeDemo" class="ztree"></ul>
	    </div>
    </div>
    <!--end of col4 -->
    <div class="col-lg-8">
    	<div id="displayDiv" style="display: none;">
    		<h1>
		    	<div id="addProductDiv" style="display: none;">
			    	<button class="btn btn-primary" data-toggle="modal" data-target="#myModal">
					  添加产品 
					</button>
				</div>
			</h1>			
    
		    <!-- 模态框 -->
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			        <h4 class="modal-title" id="myModalLabel">新增产品</h4>
			      </div>
			      <div class="modal-body">
			      	<form id="productForm" action="">
	      				<input id="hiddenCategoryId" type="hidden" name="categoryId" /> 
	      				<input id="hiddenProductId" type="hidden" name="id" /> 
			      		<div class="form-group ">
						<label class="control-label" for="inputSuccess">型号</label> <input
							id="item_no" class="form-control" type="text"
							name="item_no">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品名称</label> <input
							id="item_name" class="form-control" type="text"
							name="item_name">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品长度</label> <input
							id="size" class="form-control" type="text"
							name="size">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品宽度</label> <input
							id="width" class="form-control" type="text"
							name="width">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品单位</label> <input
							id="unit" class="form-control" type="text"
							name="unit">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品体积(m³)</label> <input
							id="volume" class="form-control" type="text"
							name="volume">
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品重量(kg)</label> <input
							id="weight" class="form-control" type="text"
							name="weight">
						</div>
						<div class="form-group ">
							<input id="hideOfficeId" type="hidden" value="${warehouse.office_id!''}" />   
                           	<label class="control-label" for="inputSuccess">请选择类别</label>
                          	<select id="categorySelect" class="form-control" name="categorySelect"></select> 
						</div>
						<div class="form-group ">
						<label class="control-label" for="inputSuccess">产品备注</label> <input
							id="item_desc" class="form-control" type="text"
							name="item_desc">
						</div>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				        <button id="productFormBtn" type="button" class="btn btn-primary">保存</button>
				      </div>
					</form>
			    </div><!-- /.modal-content -->
			 </div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
	
			<div class="panel panel-default">
					<div class="panel-heading">
	                 	<i class="fa fa-list fa-fw"></i>产品列表	    
	            	</div>
	            <div class="panel-body">
	            	<div class="row-fluid">
			 			<table class="table table-striped table-bordered table-hover datatable" id="eeda-table">
							<thead>
								<tr>
									<th>产品名称</th>
									<th>产品型号</th>
									<th>长度</th>
									<th>宽度</th>
									<th>单位</th>
									<th>体积</th>
									<th>重量</th>
									<th>备注</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<tr class="odd gradeX">
									<td colspan="5">Loading data from server</td>
								</tr>
							</tbody>
						</table>
					</div>
	      		</div>
			</div>			
	    </div>
    </div>
    <!--end of col8 -->
</div>
<!--end of row -->   
    <!-- 模态框 -->
	<div class="modal fade" id="editCategory" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title" id="myModalLabel">新增类别</h4>
	      </div>
	      <div class="modal-body">
	      	<form id="categoryForm" action="">
	      		客户<input id="hiddenCustomerId" type="text" name="customerId" /> 
	      		类别<input id="hiddenCId" type="text" name="categoryId" /> 
	      		父类<input id="hiddenParentId" type="text" name="parentId" /> 
	      		<div class="form-group ">
				<label class="control-label" for="inputSuccess">类别名称</label> <input
					id="name" class="form-control" type="text"
					name="name">
				</div>
			    <div class="modal-footer">
			        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			        <button id="categoryFormBtn" type="button" class="btn btn-primary">保存</button>
			    </div>
			</form>
	    </div><!-- /.modal-content -->
	 </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
<%}%>

<!-- Page-Level Plugin Scripts - Tables -->
<script src="/yh/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="/yh/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="/yh/js/profile/product/list.js"></script>
<link href="/yh/css/productTree.css" rel="stylesheet" />
<style type="text/css">
	.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
</style>

<link rel="stylesheet" href="/yh/js/plugins/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="/yh/js/plugins/zTree_v3/js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="/yh/js/plugins/zTree_v3/js/jquery.ztree.excheck-3.5.js"></script>
<script type="text/javascript" src="/yh/js/plugins/zTree_v3/js/jquery.ztree.exedit-3.5.js"></script>
<SCRIPT type="text/javascript">
       
        var setting = {
            view: {
            	addHoverDom: addHoverDom,
				removeHoverDom: removeHoverDom,
                selectedMulti: false
            },
            edit: {
				enable: true,
				editNameSelectAll: true,
				showRemoveBtn: showRemoveBtn,
				showRenameBtn: showRenameBtn
			},
            async: {
                enable: true,
                url:"/yh/product/searchNodeCategory",
                autoParam:["categoryId", "customerId", "level=lv"],
                otherParam:{"otherParam":"zTreeAsyncTest"},
                dataFilter: filter
            },
            callback: {
                beforeClick: beforeClick,
                onClick: onNodeClick,
                beforeAsync: beforeAsync,
                onAsyncError: onAsyncError,
                onAsyncSuccess: onAsyncSuccess,

                beforeDrag: beforeDrag,
				beforeEditName: beforeEditName,
				beforeRemove: beforeRemove,
				beforeRename: beforeRename,
				onRemove: onRemove,
				onRename: onRename
            }
        };
        
        //-------------edit--------------
		var log, className = "dark";
		function beforeDrag(treeId, treeNodes) {
			return false;
		}
		function beforeEditName(treeId, treeNode) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			zTree.selectNode(treeNode);
			return confirm("进入节点 -- " + treeNode.name + " 的编辑状态吗？");
		}
		function beforeRemove(treeId, treeNode) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			zTree.selectNode(treeNode);
			return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
		}
		function onRemove(e, treeId, treeNode) {
			showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
		}
		function beforeRename(treeId, treeNode, newName, isCancel) {
			className = (className === "dark" ? "":"dark");
			showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
			if (newName.length == 0) {
				alert("节点名称不能为空.");
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				setTimeout(function(){zTree.editName(treeNode)}, 10);
				return false;
			}
			return true;
		}
		function onRename(e, treeId, treeNode, isCancel) {
			showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
		}
		function showRemoveBtn(treeId, treeNode) {
			return !treeNode.isFirstNode;
		}
		function showRenameBtn(treeId, treeNode) {
			return !treeNode.isLastNode;
		}

		var newCount = 1;
		function addHoverDom(treeId, treeNode) {
			var sObj = $("#" + treeNode.tId + "_span");
			if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
			var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
				+ "' title='添加类别' onfocus='this.blur();'></span>";
			sObj.after(addStr);
			var btn = $("#addBtn_"+treeNode.tId);
			if (btn) btn.bind("click", function(){
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, isParent:true, name:"新类别" + (newCount++)});
				return false;
			});
		};
		function removeHoverDom(treeId, treeNode) {
			$("#addBtn_"+treeNode.tId).unbind().remove();
		};
		function selectAll() {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			zTree.setting.edit.editNameSelectAll =  $("#selectAll").attr("checked");
		}
		//-------------edit end--------------
        function onNodeClick(event, treeId, treeNode){
        	
        	$("#displayDiv").show();
    		productDataTable.fnSettings().sAjaxSource = "/yh/product/list?categoryId="+treeNode.categoryId;
        	productDataTable.fnDraw();
        }

        function filter(treeId, parentNode, childNodes) {
            if (!childNodes) return null;
            for (var i=0, l=childNodes.length; i<l; i++) {
                childNodes[i].name = childNodes[i].NAME.replace(/\.n/g, '.');
                childNodes[i].categoryId = childNodes[i].ID;
                childNodes[i].customerId = childNodes[i].CUSTOMER_ID;
                childNodes[i].parentId = childNodes[i].PARENT_ID;
                childNodes[i].isParent=true;
            }
            return childNodes;
        }
        function beforeClick(treeId, treeNode) {
            if (!treeNode.isParent) {
                alert("pls select parent node");
                return false;
            } else {
                return true;
            }
        }
        var log, className = "dark";
        function beforeAsync(treeId, treeNode) {
            className = (className === "dark" ? "":"dark");
            showLog("[ "+getTime()+" beforeAsync ]&nbsp;&nbsp;&nbsp;&nbsp;" + ((!!treeNode && !!treeNode.name) ? treeNode.name : "root") );
            return true;
        }
        function onAsyncError(event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) {
            showLog("[ "+getTime()+" onAsyncError ]&nbsp;&nbsp;&nbsp;&nbsp;" + ((!!treeNode && !!treeNode.name) ? treeNode.name : "root") );
        }
        function onAsyncSuccess(event, treeId, treeNode, msg) {
            showLog("[ "+getTime()+" onAsyncSuccess ]&nbsp;&nbsp;&nbsp;&nbsp;" + ((!!treeNode && !!treeNode.name) ? treeNode.name : "root") );
        }
        
        function showLog(str) {
            if (!log) log = $("#log");
            log.append("<li class='"+className+"'>"+str+"</li>");
            if(log.children("li").length > 8) {
                log.get(0).removeChild(log.children("li")[0]);
            }
        }
        function getTime() {
            var now= new Date(),
            h=now.getHours(),
            m=now.getMinutes(),
            s=now.getSeconds(),
            ms=now.getMilliseconds();
            return (h+":"+m+":"+s+ " " +ms);
        }

        function refreshNode(e) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
            type = e.data.type,
            silent = e.data.silent,
            nodes = zTree.getSelectedNodes();
            if (nodes.length == 0) {
                alert("pls select parent node");
            }
            for (var i=0, l=nodes.length; i<l; i++) {
                zTree.reAsyncChildNodes(nodes[i], type, silent);
                if (!silent) zTree.selectNode(nodes[i]);
            }
        }

        var zNodes =[{name:'test', categoryId:1, customerId:19, isParent:true}];
        
        $(document).ready(function(){
            $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            $("#refreshNode").bind("click", {type:"refresh", silent:false}, refreshNode);
            $("#refreshNodeSilent").bind("click", {type:"refresh", silent:true}, refreshNode);
            $("#addNode").bind("click", {type:"add", silent:false}, refreshNode);
            $("#addNodeSilent").bind("click", {type:"add", silent:true}, refreshNode);
        });
        
    </SCRIPT>