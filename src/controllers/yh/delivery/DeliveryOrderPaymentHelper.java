package controllers.yh.delivery;import java.util.List;import models.DeliveryOrderFinItem;import models.UserLogin;import models.yh.contract.Contract;import models.yh.delivery.DeliveryOrder;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;public class DeliveryOrderPaymentHelper {    public DeliveryOrderPaymentHelper() {            }        public static DeliveryOrderPaymentHelper getInstance(){        return new DeliveryOrderPaymentHelper();    }    public void genFinPerCargo(List<UserLogin> users, DeliveryOrder deliveryOrder, List<Record> transferOrderItemDetailList, Contract spContract, String chargeType) {        //发车上必须提供零担的计费方式：按体积，按公斤，按吨        String ltlPriceType = deliveryOrder.get("ltl_price_type");                double totalQuantity=0;        String colName="";        //计算总体积        if("perCBM".equals(ltlPriceType)){            colName="volume";        }        if("perKg".equals(ltlPriceType) || "perTon".equals(ltlPriceType)){            colName="weight";        }                for (Record tOrderItemRecord : transferOrderItemDetailList) {        	totalQuantity+=tOrderItemRecord.getDouble(colName);        }        if("perTon".equals(ltlPriceType)){            totalQuantity=totalQuantity/1000;        }        totalQuantity=Double.parseDouble(String.format("%.2f", totalQuantity));                genFinItemPerCBM(users, deliveryOrder, transferOrderItemDetailList, spContract, chargeType, ltlPriceType, totalQuantity);    }    private void genFinItemPerCBM(List<UserLogin> users, DeliveryOrder departOrder, List<Record> transferOrderItemList, Contract spContract,            String chargeType, String ltlPriceType, double totalQuantity) {                String sqlStart="select amount*"+totalQuantity+" as amount, fin_item_id from contract_item where contract_id ="+spContract.getLong("id");        String sqlEnd=" and priceType='"+chargeType+"' and ltlunittype='"+ltlPriceType                + "' and ifnull(amountfrom, 0)<"+totalQuantity+" and "+totalQuantity + "<=ifnull(amountto, 10000000)";        Record contractFinItem = Db                .findFirst(sqlStart                        + "  and from_id = '" + departOrder.get("route_from")                        + "' and to_id = '" + departOrder.get("route_to")+"' "                        + sqlEnd);        if (contractFinItem != null) {            genFinItem(users, departOrder, null, contractFinItem);        }else{            contractFinItem = Db                    .findFirst(sqlStart                            +" and to_id = '" + departOrder.get("route_to") + "' "                            + sqlEnd);            if (contractFinItem != null) {                genFinItem(users, departOrder, null, contractFinItem);            }        }    }        private void genFinItem( List<UserLogin> users, DeliveryOrder deliveryOrder, Record tOrderItemRecord, Record contractFinItem) {        java.util.Date utilDate = new java.util.Date();        java.sql.Timestamp now = new java.sql.Timestamp(utilDate.getTime());        DeliveryOrderFinItem deliveryOrderFinItem = new DeliveryOrderFinItem();        deliveryOrderFinItem.set("fin_item_id", contractFinItem.get("fin_item_id"));        deliveryOrderFinItem.set("amount", contractFinItem.getDouble("amount"));        deliveryOrderFinItem.set("order_id", deliveryOrder.getLong("id"));        deliveryOrderFinItem.set("status", "未完成");        deliveryOrderFinItem.set("creator", users.get(0).get("id"));        deliveryOrderFinItem.set("create_date", now);        deliveryOrderFinItem.set("create_name", "system");        deliveryOrderFinItem.save();    }}