package controllers.yh.contract;import java.util.HashMap;import java.util.List;import java.util.Map;import javax.servlet.http.HttpServletRequest;import models.Party;import com.jfinal.core.Controller;import com.jfinal.log.Logger;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;public class ContractController extends Controller {    private Logger logger = Logger.getLogger(ContractController.class);    // in config route已经将路径默认设置为/yh    // me.add("/yh", controllers.yh.AppController.class, "/yh");    public void index() {        HttpServletRequest re= getRequest();        String url = re.getRequestURI();        logger.debug("URI:" + url);       if(url.equals("/yh/customerContract")){            setAttr("contractType","CUSTOMER");            render("contract/ContractList.html");        }else {            setAttr("contractType","SP");            render("contract/ContractList.html");        }          }       //客户合同列表    public void customerList(){        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }              //获取总条数        String totalWhere="";        String sql = "select count(1) total from contract c,party p,contact c1 where c.party_id= p.id and p.contact_id = c1.id and c.type='CUSTOMER'  ";        System.out.println(sql);        Record rec = Db.findFirst(sql + totalWhere);        long total = rec.getLong("total");        logger.debug("total records:" + total);                //获取当前页的数据       List<Record> orders = Db.find("select * from contract c,party p,contact c1 where c.party_id= p.id and p.contact_id = c1.id and c.type='CUSTOMER'");        //List<Record> orders = Db.find("select * from contract where type='CUSTOMER'");        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", total);        orderMap.put("iTotalDisplayRecords", total);        orderMap.put("aaData", orders);                renderJson(orderMap);    }        //供应商合同列表    public void spList(){        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }                //获取总条数        String totalWhere="";        String sql = "select count(1) total from contract c,party p,contact c1 where c.party_id= p.id and p.contact_id = c1.id and c.type='SERVICE_PROVIDER'";        System.out.println(sql);        Record rec = Db.findFirst(sql + totalWhere);        logger.debug("total records:" + rec.getLong("total"));                //获取当前页的数据        List<Record> orders = Db.find("select * from contract c,party p,contact c1 where c.party_id= p.id and p.contact_id = c1.id and c.type='SERVICE_PROVIDER'");        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", orders);                renderJson(orderMap);      }       public void add() {        setAttr("saveOK", false);        render("/yh/contract/ContractEdit.html");    }    public void edit() {        long id = getParaToLong();        Party party = Party.dao.findById(id);        setAttr("party", party);        render("contract/ContractEdit.html");    }    public void save() {                setAttr("saveOK", true);        redirect("/yh/customerContract/ContractEdit/");    }        public void delete(){        String id = getPara();        if (id != null) {        Db.deleteById("contract", id);        }        render("contract/ContractList.html");    }    //列出客户公司名称    public void search() {        HttpServletRequest re= getRequest();        String url = re.getRequestURI();        String locationName = getPara("locationName");        // 不能查所有        if (locationName.trim().length() > 0) {                        if(url.equals("/yh/customerContract/add")){                List<Record> locationList = Db.find("select * from party p,contact c where p.contact_id = c.id and p.party_type = 'CUSTOMER' and c.company_name like '%" + locationName + "%'");                renderJson(locationList);            }else {                List<Record> locationList = Db.find("select * from party p,contact c where p.contact_id = c.id and p.party_type = 'SERVICE_PROVIDER' and c.company_name like '%" + locationName + "%'");                renderJson(locationList);            }                    }    }}