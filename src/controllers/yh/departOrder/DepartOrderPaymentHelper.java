package controllers.yh.departOrder;import java.math.BigDecimal;import java.util.List;import models.DepartOrder;import models.DepartOrderFinItem;import models.UserLogin;import models.yh.contract.Contract;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;public class DepartOrderPaymentHelper {    public DepartOrderPaymentHelper() {            }        public static DepartOrderPaymentHelper getInstance(){        return new DepartOrderPaymentHelper();    }    public void genFinPerCargo(List<UserLogin> users, DepartOrder departOrder, List<Record> transferOrderItemList, Contract spContract,            String chargeType) {        //发车上必须提供零担的计费方式：按体积，按公斤，按吨        String ltlPriceType = departOrder.get("ltl_price_type");                double totalQuantity=0;        String colName="";        //计算总体积        if("perCBM".equals(ltlPriceType)){            colName="volume";        }        if("perKg".equals(ltlPriceType) || "perTon".equals(ltlPriceType)){            colName="sum_weight";        }                for (Record tOrderItemRecord : transferOrderItemList) {        	totalQuantity+=tOrderItemRecord.getDouble(colName);        }        if("perTon".equals(ltlPriceType)){            totalQuantity=totalQuantity/1000;        }        //统一向上取整，不足一 立方(/公斤/吨)，按一 立方(/公斤/吨) 算        //totalQuantity=Math.ceil(totalQuantity);        totalQuantity=Double.parseDouble(String.format("%.2f", totalQuantity));                genFinItemPerCBM(users, departOrder, transferOrderItemList, spContract, chargeType, ltlPriceType, totalQuantity);    }    private void genFinItemPerCBM(List<UserLogin> users, DepartOrder departOrder, List<Record> transferOrderItemList, Contract spContract,            String chargeType, String ltlPriceType, double totalQuantity) {                String sqlStart="select amount*"+totalQuantity+" as amount, fin_item_id from contract_item where contract_id ="+spContract.getLong("id");        String sqlEnd=" and priceType='"+chargeType+"' and ltlunittype='"+ltlPriceType                + "' and ifnull(amountfrom, 0)<"+totalQuantity+" and "+totalQuantity + "<=ifnull(amountto, 10000000)";        Record contractFinItem = Db                .findFirst(sqlStart                        + "  and from_id = '" + departOrder.get("route_from")                        + "' and to_id = '" + departOrder.get("route_to")+"' "                        + sqlEnd);        if (contractFinItem != null) {            genFinItem(users, departOrder, null, contractFinItem);        }else{            contractFinItem = Db                    .findFirst(sqlStart                            +" and to_id = '" + departOrder.get("route_to") + "' "                            + sqlEnd);            if (contractFinItem != null) {                genFinItem(users, departOrder, null, contractFinItem);            }        }    }        private void genFinItem( List<UserLogin> users, DepartOrder departOrder, Record tOrderItemRecord, Record contractFinItem) {        java.util.Date utilDate = new java.util.Date();        java.sql.Timestamp now = new java.sql.Timestamp(utilDate.getTime());        double money =contractFinItem.getDouble("amount");        BigDecimal bg = new BigDecimal(money);        double amountDouble = bg.setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();        DepartOrderFinItem departOrderFinItem = new DepartOrderFinItem();        departOrderFinItem.set("fin_item_id", contractFinItem.get("fin_item_id"));        departOrderFinItem.set("amount", amountDouble);        departOrderFinItem.set("depart_order_id", departOrder.getLong("id"));        departOrderFinItem.set("status", "未完成");        departOrderFinItem.set("creator", users.get(0).get("id"));        departOrderFinItem.set("create_date", now);        departOrderFinItem.set("create_name", "system");        departOrderFinItem.set("transfer_order_id", tOrderItemRecord.get("order_id"));        departOrderFinItem.set("transfer_order_item_id", tOrderItemRecord.get("id"));        departOrderFinItem.save();    }}