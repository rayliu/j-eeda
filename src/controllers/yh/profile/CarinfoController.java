package controllers.yh.profile;import java.util.Calendar;import java.util.Date;import java.util.HashMap;import java.util.List;import java.util.Map;import javax.servlet.http.HttpServletRequest;import models.DepartOrder;import models.Party;import models.yh.profile.Carinfo;import models.yh.profile.Contact;import org.apache.shiro.SecurityUtils;import org.apache.shiro.authz.annotation.RequiresAuthentication;import org.apache.shiro.subject.Subject;import com.jfinal.core.Controller;import com.jfinal.log.Logger;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;import controllers.yh.LoginUserController;@RequiresAuthenticationpublic class CarinfoController extends Controller {    private Logger logger = Logger.getLogger(CarinfoController.class);    // in config route已经将路径默认设置为/yh    // me.add("/yh", controllers.yh.AppController.class, "/yh");    static Subject currentUser = SecurityUtils.getSubject();    public void index() {        HttpServletRequest re = getRequest();        String url = re.getRequestURI();        logger.debug("URI:" + url);        if (url.equals("/carinfo")) {                render("/yh/profile/carinfo/carlist.html");        }        if (url.equals("/carmanage")) {                render("/yh/carmanage/carmanage.html");        }        if (url.equals("/driverinfo")) {                render("/yh/profile/carinfo/driverlist.html");        }        if (url.equals("/spcarinfo")) {                render("/yh/profile/carinfo/spcarList.html");        }        if (url.equals("/spdriverinfo")) {        		render("/yh/profile/carinfo/spDriverList.html");        }    }    public void list() {        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }        // 获取总条数        String totalWhere = "";        String sql = "select count(1) total from carinfo where type = '" + Carinfo.CARINFO_TYPE_OWN +"'";        Record rec = Db.findFirst(sql + totalWhere);        logger.debug("total records:" + rec.getLong("total"));        // 获取当前页的数据        List<Record> orders = Db.find("select * from carinfo where type = '" + Carinfo.CARINFO_TYPE_OWN +"' " + sLimit);        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", orders);        renderJson(orderMap);    }    public void driverlist() {        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }        // 获取总条数        String totalWhere = "";        String sql = "select count(1) total from party where party_type='DRIVER'";        Record rec = Db.findFirst(sql + totalWhere);        logger.debug("total records:" + rec.getLong("total"));        // 获取当前页的数据        List<Record> orders = Db.find("select c.license license,c.contact_person,c.phone,c.identification,p.id as pid from party p left join contact c on p.contact_id =c.id where party_type='DRIVER'" + sLimit);        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", orders);        renderJson(orderMap);    }    // 发车记录单list    public void carmanageList() {        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }        // 获取总条数        String totalWhere = "";        String sql = "select count(1) total from depart_order dor " + ""                    + " left join carinfo c on dor.driver_id = c.id " + " where dor.status!='取消' and combine_type = '"                    + DepartOrder.COMBINE_TYPE_PICKUP + "' and (dor.status = '已入货场' or dor.status = '已入库' ) and dor.pickup_mode = 'own'";        Record rec = Db.findFirst(sql + totalWhere);        logger.debug("total records:" + rec.getLong("total"));        // 获取当前页的数据        List<Record> orders = Db.find("select dor.*,ct.contact_person,ct.phone,c.car_no,c.cartype,c.status cstatus,c.length, (select group_concat(dt.transfer_order_no separator '\r\n')  from depart_transfer dt where depart_id = dor.id)  as transfer_order_no  from depart_order dor "                    + " left join carinfo c on dor.carinfo_id = c.id "                    + " left join party p on dor.driver_id = p.id "                    + " left join contact ct on p.contact_id = ct.id "                    + " where dor.status!='取消' and combine_type = '"                    + DepartOrder.COMBINE_TYPE_PICKUP + "' and combine_type = 'PICKUP' and (dor.status = '已入货场' or dor.status = '已入库' ) and dor.pickup_mode = 'own' order by dor.create_stamp desc " + sLimit);        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", orders);        renderJson(orderMap);    }    public void add() {            render("/yh/profile/carinfo/edit.html");    }    public void driveradd() {            render("/yh/profile/carinfo/driveredit.html");    }    // 添加车辆    public void save() {        String id = getPara("carId");        Carinfo carinfo = null;        if (id != "") {            carinfo = Carinfo.dao.findById(id);            setCarifo(carinfo);            carinfo.set("type", Carinfo.CARINFO_TYPE_OWN);            carinfo.set("hundred_fuel_standard", getPara("hundred_fuel_standard"));            carinfo.update();        } else {            carinfo = new Carinfo();            setCarifo(carinfo);            carinfo.set("type", Carinfo.CARINFO_TYPE_OWN);            carinfo.set("hundred_fuel_standard", getPara("hundred_fuel_standard"));            carinfo.save();        }        redirect("/carinfo");    }    // 添加司机保存    public void driversave() {        String id = getPara("driverId");        Party party = null;        Contact contact = null;        Date createDate = Calendar.getInstance().getTime();        if (!id.isEmpty()) {            party = Party.dao.findById(id);            party.set("last_update_date", createDate);            party.update();            contact = Contact.dao.findFirst("select c.* from contact c,party p where c.id=p.contact_id and p.id=" + id);            setContact(contact);            contact.update();        } else {            contact = new Contact();            setContact(contact);            contact.save();            party = new Party();            party.set("party_type", Party.PARTY_TYPE_DRIVER);            party.set("contact_id", contact.getLong("id"));            party.set("creator", currentUser.getPrincipal());            party.set("create_date", createDate);            party.save();        }        setAttr("saveOK", true);        	redirect("/driverinfo");    }    private void setContact(Contact contact) {        // contact.set("company_name", getPara("company_name"));        contact.set("contact_person", getPara("driver"));        contact.set("phone", getPara("phone"));        contact.set("identification", getPara("identification"));        contact.set("license", getPara("license"));    }    public void setCarifo(Carinfo carinfo) {        carinfo.set("driver", getPara("driver"));        carinfo.set("cartype", getPara("ctype"));        carinfo.set("car_no", getPara("car_number"));        carinfo.set("phone", getPara("phone"));        carinfo.set("length", getPara("length"));    }    public void delect() {        String id = getPara();        if (id != null) {            Carinfo.dao.deleteById(id);        }        renderJson("{\"success\":true}");    }    public void driverdelect() {        long id = getParaToLong();        Party party = Party.dao.findById(id);        Contact contact = Contact.dao.findFirst("select c.* from contact c,party p where c.id=p.contact_id and p.id="                + id);        ;        contact.delete();        party.delete();        renderJson("{\"success\":true}");    }    public void edit() {        String id = getPara();        Carinfo carinfo = Carinfo.dao.findById(id);        System.out.println(carinfo);        setAttr("lu", carinfo);        render("/yh/profile/carinfo/edit.html");    }    public void driveredit() {        String id = getPara();        Party party = Party.dao.findById(id);        Contact contact = Contact.dao.findById(party.get("contact_id"));        System.out.println(party);        System.out.println(contact);        setAttr("lu", party);        setAttr("lu2", contact);        render("/yh/profile/carinfo/driveredit.html");    }        // 供应商车辆信息    public void spCarInfoList(){    	String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }        // 获取总条数        String totalWhere = "";        String sql = "select count(1) total from carinfo where type = '" + Carinfo.CARINFO_TYPE_SP +"'";        Record rec = Db.findFirst(sql + totalWhere);        logger.debug("total records:" + rec.getLong("total"));        // 获取当前页的数据        List<Record> orders = Db.find("select * from carinfo where type = '" + Carinfo.CARINFO_TYPE_SP +"' " + sLimit);        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", orders);        renderJson(orderMap);    }        public void addSpCarInfo() {            render("/yh/profile/carinfo/spCarInfoEdit.html");    }        public void saveSpCarInfo() {        String id = getPara("carId");        Carinfo carinfo = null;        if (id != "" && !"".equals(id)) {            carinfo = Carinfo.dao.findById(id);            setCarifo(carinfo);            carinfo.set("type", Carinfo.CARINFO_TYPE_SP);            carinfo.update();        } else {            carinfo = new Carinfo();            setCarifo(carinfo);            carinfo.set("type", Carinfo.CARINFO_TYPE_SP);            carinfo.save();        }        redirect("/spcarinfo");    }        public void editSpCarInfo() {        String id = getPara();        Carinfo carinfo = Carinfo.dao.findById(id);        System.out.println(carinfo);        setAttr("lu", carinfo);        render("/yh/profile/carinfo/spCarInfoEdit.html");    }        public void deleteSpCarInfo() {    	String id = getPara();    	Carinfo.dao.deleteById(id);    	redirect("/spcarinfo");    }            // 供应商司机信息    public void spDriverList(){    	String sLimit = "";    	String pageIndex = getPara("sEcho");    	if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {    		sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");    	}    	// 获取总条数    	String totalWhere = "";    	String sql = "select count(1) total from party where party_type = '" + Party.PARTY_TYPE_SP_DRIVER +"'";    	Record rec = Db.findFirst(sql + totalWhere);    	logger.debug("total records:" + rec.getLong("total"));    	    	// 获取当前页的数据    	List<Record> orders = Db.find("select p.*,p.id pid,c.* from party p left join contact c on c.id = p.contact_id where party_type = '" + Party.PARTY_TYPE_SP_DRIVER +"' " + sLimit);    	Map orderMap = new HashMap();    	orderMap.put("sEcho", pageIndex);    	orderMap.put("iTotalRecords", rec.getLong("total"));    	orderMap.put("iTotalDisplayRecords", rec.getLong("total"));    	orderMap.put("aaData", orders);    	    	renderJson(orderMap);    }        public void addSpDriver() {    		render("/yh/profile/carinfo/spDriverEdit.html");    }        public void saveSpDriver() {    	String id = getPara("driverId");        Party party = null;        Contact contact = null;        if (!"".equals(id) && id != null) {            party = Party.dao.findById(id);            party.set("last_update_date", new Date());            party.update();            contact = Contact.dao.findFirst("select c.* from contact c,party p where c.id=p.contact_id and p.id=" + id);            setContact(contact);            contact.update();        } else {            contact = new Contact();            setContact(contact);            contact.save();            party = new Party();            party.set("contact_id", contact.getLong("id"));            party.set("creator", currentUser.getPrincipal());            party.set("create_date", new Date());            party.set("party_type", Party.PARTY_TYPE_SP_DRIVER);            party.save();        }        setAttr("saveOK", true);        	redirect("/spdriverinfo");    }            public void editSpDriver() {    	String id = getPara();        Party party = Party.dao.findById(id);        Contact contact = Contact.dao.findById(party.get("contact_id"));        setAttr("lu", party);        setAttr("lu2", contact);    	render("/yh/profile/carinfo/spDriverEdit.html");    }        public void deleteSpDriver() {    	String id = getPara();    	Party.dao.deleteById(id);    	redirect("/spdriverinfo");    }}