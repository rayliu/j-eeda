package controllers.eeda;import java.util.Date;import java.util.HashMap;import java.util.List;import java.util.Map;import models.eeda.ServiceProvider;import org.apache.commons.mail.DefaultAuthenticator;import org.apache.commons.mail.Email;import org.apache.commons.mail.SimpleEmail;import org.apache.shiro.SecurityUtils;import org.apache.shiro.subject.Subject;import com.jfinal.core.Controller;import com.jfinal.log.Logger;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;import controllers.eeda.util.DataTablesUtils;public class ServiceProviderController extends Controller {    private Logger logger = Logger.getLogger(ServiceProviderController.class);    Subject currentUser = SecurityUtils.getSubject();    private boolean isAuthenticated() {        if (!currentUser.isAuthenticated()) {            redirect("/login");            return false;        }        setAttr("userId", currentUser.getPrincipal());        return true;    }    public void index() {        if (!isAuthenticated())            return;        List<ServiceProvider> spList = ServiceProvider.dao.find("select * from DP_PROF_PROVIDER_INFO ");        System.out.println("size:" + spList.size());        render("/eeda/sp/list.html");    }    public void list() {        if (!isAuthenticated())            return;        String sLimit = "";        String pageIndex = getPara("sEcho");        if (getPara("iDisplayStart") != null && getPara("iDisplayLength") != null) {            sLimit = " LIMIT " + getPara("iDisplayStart") + ", " + getPara("iDisplayLength");        }        String strWhere = DataTablesUtils.buildSingleFilter(this);        Record rec = Db.findFirst("select count(1) total from DP_PROF_PROVIDER_INFO " + strWhere);        List<ServiceProvider> spList = ServiceProvider.dao.find("select * from DP_PROF_PROVIDER_INFO " + strWhere + sLimit);        System.out.println("size:" + spList.size());        Map orderMap = new HashMap();        orderMap.put("sEcho", pageIndex);        orderMap.put("iTotalRecords", rec.getLong("total"));        orderMap.put("iTotalDisplayRecords", rec.getLong("total"));        orderMap.put("aaData", spList);        renderJson(orderMap);    }    // 使用common-email, javamail    public void sendMarketingMail() throws Exception {        if (!isAuthenticated())            return;        String id = getPara("id");        ServiceProvider sp = ServiceProvider.dao.findById(id);        String emailAddress = "";        if (sp.getStr("EMAIL") != null)            emailAddress = sp.getStr("EMAIL");        logger.debug("will send EMAIL to:" + emailAddress);        String name = getPara("name");        String content = getPara("content");        String returnFlag = "fail";        try {            Email email = new SimpleEmail();            email.setHostName("smtp.exmail.qq.com");            email.setSmtpPort(465);            email.setAuthenticator(new DefaultAuthenticator("news@eeda123.com", "Eeda123"));            email.setSSLOnConnect(true);            email.setFrom("news@eeda123.com");            email.setSubject("易达物流企业管理平台");            email.setMsg("tst......");            email.addTo("ray_liuyu@qq.com");            email.send();            returnFlag = "ok";        } catch (Exception e) {            e.printStackTrace();            returnFlag = "fail";        }        sp.set("mail_sent_time", new Date()).update();        renderJson(returnFlag);    }}